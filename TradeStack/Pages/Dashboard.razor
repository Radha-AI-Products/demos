@page "/"
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.SplitButtons
@using Syncfusion.Blazor.Cards
@using Syncfusion.Blazor.Charts
@using Syncfusion.Blazor.Grids
@using TradeStack.Models
@using TradeStack.Components.Dashboard

<div class="ts-dashboard-shell">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
            <h4 class="mb-1">Dashboard</h4>
            <div class="text-muted">Portfolio overview, performance, and activity.</div>
        </div>
        <div class="d-flex gap-2">
            <SfButton CssClass="e-outline" Content="New Order" IconCss="fa-solid fa-plus"></SfButton>
            <SfButton IsPrimary="true" Content="Deposit" IconCss="fa-solid fa-arrow-down"></SfButton>
        </div>
    </div>

    <div class="row g-3">
        @foreach (var kpi in kpis)
        {
            <div class="col-12 col-md-6 col-xl-3">
                <KpiCard Title="@kpi.Title" Value="@kpi.PrimaryValue" Delta="@kpi.DeltaText" IsPositive="@kpi.IsPositive" Spark="@kpi.Sparkline" />
            </div>
        }
    </div>

    <div class="row g-3">
        <div class="col-12 col-xl-8">
            <SfCard CssClass="ts-card">
                <CardContent>
                    <div class="ts-card-header mb-2">
                        <div>
                            <div class="ts-section-title">Portfolio performance</div>
                            <div class="text-muted small">Net liquidation value over time</div>
                        </div>
                        <SfButtonGroup CssClass="ts-btnseg" Mode="Syncfusion.Blazor.SplitButtons.SelectionMode.Single">
                            <ButtonGroupButton @bind-Selected="oneDaySelected" @bind-Selected:after="OnRangeChanged">1D</ButtonGroupButton>
                            <ButtonGroupButton @bind-Selected="oneWeekSelected" @bind-Selected:after="OnRangeChanged">1W</ButtonGroupButton>
                            <ButtonGroupButton @bind-Selected="oneMonthSelected" @bind-Selected:after="OnRangeChanged">1M</ButtonGroupButton>
                            <ButtonGroupButton @bind-Selected="sixMonthsSelected" @bind-Selected:after="OnRangeChanged">6M</ButtonGroupButton>
                            <ButtonGroupButton @bind-Selected="oneYearSelected" @bind-Selected:after="OnRangeChanged">1Y</ButtonGroupButton>
                        </SfButtonGroup>
                    </div>

                    <div class="ts-chart-wrap">
                        <SfChart @ref="performanceChart" Height="320px">
                            <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.DateTime"></ChartPrimaryXAxis>
                            <ChartCrosshairSettings Enable="true" LineType="LineType.Vertical"></ChartCrosshairSettings>
                            <ChartTooltipSettings Enable="true" Shared="true" Format="${point.x} : ${point.y}"></ChartTooltipSettings>
                            <ChartSeriesCollection>
                                <ChartSeries Name="Portfolio" DataSource="@performanceData" XName="Date" YName="Value" Type="ChartSeriesType.Line"></ChartSeries>
                            </ChartSeriesCollection>
                        </SfChart>
                    </div>
                </CardContent>
            </SfCard>
        </div>

        <div class="col-12 col-xl-4">
            <SfCard CssClass="ts-card">
                <CardContent>
                    <div class="ts-card-header mb-2">
                        <div>
                            <div class="ts-section-title">Asset allocation</div>
                            <div class="text-muted small">Exposure by asset class</div>
                        </div>
                    </div>

                    <SfAccumulationChart Height="320px">
                        <AccumulationChartSeriesCollection>
                            <AccumulationChartSeries DataSource="@allocation" XName="Asset" YName="Weight" InnerRadius="60%" Radius="95%" Type="AccumulationType.Pie" Name="Allocation">
                            </AccumulationChartSeries>
                        </AccumulationChartSeriesCollection>
                        <AccumulationChartLegendSettings Visible="true" Position="LegendPosition.Bottom"></AccumulationChartLegendSettings>
                        <AccumulationChartTooltipSettings Enable="true" Format="${point.x} : ${point.y}%"></AccumulationChartTooltipSettings>
                    </SfAccumulationChart>
                </CardContent>
            </SfCard>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-12 col-xl-8">
            <SfCard CssClass="ts-card">
                <CardContent>
                    <div class="ts-card-header mb-2">
                        <div>
                            <div class="ts-section-title">Recent activity</div>
                            <div class="text-muted small">Orders and executions</div>
                        </div>
                        <a class="text-decoration-none" href="/orders">View all</a>
                    </div>

                    <SfGrid TValue="ActivityItemModel" DataSource="@activity" AllowSorting="true" AllowPaging="true">
                        <GridPageSettings PageSize="6"></GridPageSettings>
                        <GridColumns>
                            <GridColumn Field=@nameof(ActivityItemModel.Time) HeaderText="Time" Format="g" Type="Syncfusion.Blazor.Grids.ColumnType.Date" Width="160" />
                            <GridColumn Field=@nameof(ActivityItemModel.Type) HeaderText="Type" Width="120" />
                            <GridColumn Field=@nameof(ActivityItemModel.Symbol) HeaderText="Symbol" Width="110" />
                            <GridColumn Field=@nameof(ActivityItemModel.Side) HeaderText="Side" Width="110" />
                            <GridColumn Field=@nameof(ActivityItemModel.Qty) HeaderText="Qty" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Right" Width="90" />
                            <GridColumn Field=@nameof(ActivityItemModel.Price) HeaderText="Price" Format="C2" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Right" Width="120" />
                            <GridColumn Field=@nameof(ActivityItemModel.Status) HeaderText="Status" Width="130" />
                        </GridColumns>
                    </SfGrid>
                </CardContent>
            </SfCard>
        </div>

        <div class="col-12 col-xl-4">
            <div class="d-flex flex-column gap-3">
                <SfCard CssClass="ts-card">
                    <CardContent>
                        <div class="ts-card-header mb-2">
                            <div>
                                <div class="ts-section-title">Watchlist</div>
                                <div class="text-muted small">Quick view</div>
                            </div>
                            <a class="text-decoration-none" href="/watchlist">Open</a>
                        </div>

                        @foreach (var w in watchlist)
                        {
                            var isPos = w.ChangePct >= 0;
                            <div class="ts-watchlist-row">
                                <div>
                                    <div class="fw-semibold">@w.Symbol <span class="text-muted fw-normal">@w.Name</span></div>
                                    <div class="text-muted small">Last @w.Last.ToString("N2")</div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-semibold">@w.Last.ToString("N2")</div>
                                    <div class="ts-pill @(isPos ? "ts-pill-pos" : "ts-pill-neg")">@w.ChangePct.ToString("+0.00;-0.00")%</div>
                                </div>
                            </div>
                        }
                    </CardContent>
                </SfCard>

                <SfCard CssClass="ts-card">
                    <CardContent>
                        <div class="ts-card-header mb-2">
                            <div>
                                <div class="ts-section-title">Positions snapshot</div>
                                <div class="text-muted small">Top open positions</div>
                            </div>
                        </div>

                        <div class="ts-mini-table">
                            @foreach (var p in positions)
                            {
                                var isPos = p.ChangePct >= 0;
                                <div class="d-flex align-items-center justify-content-between py-2">
                                    <div>
                                        <div class="fw-semibold">@p.Symbol</div>
                                        <div class="text-muted">@p.Qty.ToString("N0") shares</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-semibold">@p.MarketValue.ToString("C0")</div>
                                        <div class="@(isPos ? "text-success" : "text-danger") small">@p.ChangePct.ToString("+0.00;-0.00")%</div>
                                    </div>
                                </div>
                                <div class="border-top" style="border-color: rgba(0,0,0,.06) !important;"></div>
                            }
                        </div>
                    </CardContent>
                </SfCard>
            </div>
        </div>
    </div>
</div>

@code {
    private SfChart? performanceChart;

    private List<DashboardKpiModel> kpis = new();
    private List<PortfolioPointModel> performanceData = new();
    private List<AllocationSliceModel> allocation = new();
    private List<ActivityItemModel> activity = new();
    private List<WatchlistQuoteModel> watchlist = new();

    private bool oneDaySelected;
    private bool oneWeekSelected;
    private bool oneMonthSelected;
    private bool sixMonthsSelected;
    private bool oneYearSelected = true;

    private DashboardRange selectedRange = DashboardRange.OneYear;

    private List<(string Symbol, int Qty, double MarketValue, double ChangePct)> positions = new();

    protected override void OnInitialized()
    {
        kpis = new()
        {
            new()
            {
                Title = "Total Portfolio Value",
                PrimaryValue = "$128,430.22",
                DeltaText = "+1.24%",
                IsPositive = true,
                Sparkline = MakeSpark(new double[]{ 10, 12, 11, 13, 16, 15, 18, 21, 20, 24 })
            },
            new()
            {
                Title = "Today’s P/L",
                PrimaryValue = "+$1,240.18",
                DeltaText = "+0.82%",
                IsPositive = true,
                Sparkline = MakeSpark(new double[]{ 8, 7, 9, 10, 12, 11, 14, 13, 15, 16 })
            },
            new()
            {
                Title = "Available Margin",
                PrimaryValue = "$34,600",
                DeltaText = "-0.30%",
                IsPositive = false,
                Sparkline = MakeSpark(new double[]{ 18, 18, 17, 16, 16, 15, 15, 14, 14, 13 })
            },
            new()
            {
                Title = "Open Positions",
                PrimaryValue = "9",
                DeltaText = "+2",
                IsPositive = true,
                Sparkline = MakeSpark(new double[]{ 4, 5, 5, 6, 6, 7, 8, 8, 9, 9 })
            }
        };

        allocation = new()
        {
            new() { Asset = "Equities", Weight = 58 },
            new() { Asset = "Options", Weight = 17 },
            new() { Asset = "Crypto", Weight = 9 },
            new() { Asset = "FX", Weight = 6 },
            new() { Asset = "Cash", Weight = 10 }
        };

        activity = new()
        {
            new() { Id = 1, Time = DateTime.Today.AddHours(9).AddMinutes(14), Type = "Order", Symbol = "AAPL", Side = "Buy", Qty = 10, Price = 186.12, Status = "Filled" },
            new() { Id = 2, Time = DateTime.Today.AddHours(10).AddMinutes(2), Type = "Order", Symbol = "TSLA", Side = "Sell", Qty = 3, Price = 212.44, Status = "Filled" },
            new() { Id = 3, Time = DateTime.Today.AddHours(10).AddMinutes(41), Type = "Alert", Symbol = "NVDA", Side = "—", Qty = 0, Price = 0, Status = "Triggered" },
            new() { Id = 4, Time = DateTime.Today.AddHours(11).AddMinutes(5), Type = "Order", Symbol = "SPY", Side = "Buy", Qty = 5, Price = 493.87, Status = "Open" },
            new() { Id = 5, Time = DateTime.Today.AddHours(11).AddMinutes(38), Type = "Order", Symbol = "MSFT", Side = "Buy", Qty = 6, Price = 412.20, Status = "Canceled" },
            new() { Id = 6, Time = DateTime.Today.AddHours(12).AddMinutes(6), Type = "Order", Symbol = "AMD", Side = "Buy", Qty = 12, Price = 172.31, Status = "Filled" },
            new() { Id = 7, Time = DateTime.Today.AddHours(13).AddMinutes(18), Type = "Order", Symbol = "META", Side = "Sell", Qty = 2, Price = 481.90, Status = "Filled" },
            new() { Id = 8, Time = DateTime.Today.AddHours(14).AddMinutes(3), Type = "Order", Symbol = "QQQ", Side = "Buy", Qty = 4, Price = 421.63, Status = "Open" },
            new() { Id = 9, Time = DateTime.Today.AddHours(14).AddMinutes(48), Type = "Order", Symbol = "ETH", Side = "Buy", Qty = 1, Price = 2460.00, Status = "Filled" }
        };

        watchlist = new()
        {
            new() { Symbol = "AAPL", Name = "Apple", Last = 186.12, ChangePct = 0.42, Company = "Apple", CurrentPrice = 186.12, DayChangePct = 0.0042 },
            new() { Symbol = "NVDA", Name = "NVIDIA", Last = 728.43, ChangePct = -0.78, Company = "NVIDIA", CurrentPrice = 728.43, DayChangePct = -0.0078 },
            new() { Symbol = "TSLA", Name = "Tesla", Last = 212.44, ChangePct = 1.18, Company = "Tesla", CurrentPrice = 212.44, DayChangePct = 0.0118 },
            new() { Symbol = "BTC", Name = "Bitcoin", Last = 51240.20, ChangePct = 0.66, Company = "Bitcoin", CurrentPrice = 51240.20, DayChangePct = 0.0066 }
        };

        positions = new()
        {
            ("AAPL", 45, 8375, 0.44),
            ("NVDA", 12, 8712, -0.62),
            ("MSFT", 20, 8240, 0.21)
        };

        ApplyRange(selectedRange);
    }

    private List<KpiSparkPointModel> MakeSpark(IEnumerable<double> values)
    {
        var i = 0;
        return values.Select(v => new KpiSparkPointModel { Index = i++, Value = v }).ToList();
    }

    private async Task OnRangeChanged()
    {
        if (oneDaySelected) selectedRange = DashboardRange.OneDay;
        else if (oneWeekSelected) selectedRange = DashboardRange.OneWeek;
        else if (oneMonthSelected) selectedRange = DashboardRange.OneMonth;
        else if (sixMonthsSelected) selectedRange = DashboardRange.SixMonths;
        else selectedRange = DashboardRange.OneYear;

        ApplyRange(selectedRange);

        if (performanceChart is not null)
        {
            await performanceChart.RefreshAsync(true);
        }
    }

    private void ApplyRange(DashboardRange range)
    {
        var end = DateTime.Today.AddDays(1).AddMinutes(-1);
        var start = range switch
        {
            DashboardRange.OneDay => end.AddDays(-1),
            DashboardRange.OneWeek => end.AddDays(-7),
            DashboardRange.OneMonth => end.AddDays(-30),
            DashboardRange.SixMonths => end.AddDays(-180),
            _ => end.AddDays(-365)
        };

        var points = range switch
        {
            DashboardRange.OneDay => 24,
            DashboardRange.OneWeek => 28,
            DashboardRange.OneMonth => 30,
            DashboardRange.SixMonths => 36,
            _ => 52
        };

        var rng = new Random(42 + (int)range);
        var baseValue = 118_000d;
        var step = (128_000d - baseValue) / Math.Max(1, points - 1);

        var data = new List<PortfolioPointModel>();
        for (var i = 0; i < points; i++)
        {
            var t = i / (double)(points - 1);
            var date = start.AddSeconds((end - start).TotalSeconds * t);
            var noise = (rng.NextDouble() - 0.5) * (range == DashboardRange.OneDay ? 900 : 1600);
            data.Add(new PortfolioPointModel { Date = date, Value = baseValue + (step * i) + noise });
        }

        performanceData = data;
    }
}
